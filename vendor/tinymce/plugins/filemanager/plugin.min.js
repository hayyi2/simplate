tinymce.PluginManager.add("filemanager", function(e) {
    function openmanager(field_name, url, type, win) {
        e.windowManager.close();

        var r = window.innerWidth - 100,
        g = window.innerHeight - 160;
        if (r > 1800 && (r = 1800), g > 1200 && (g = 1200), r > 600) {
            var d = (r - 20) % 138;
            var r = r - d + 10;
        }

        win = e.windowManager.open({
            title: 'File Manager',
            file: e.settings.media_main + "&open=" + type,
            filetype: 'all',
            classes: 'filemanager',
            width: r,
            height: g,
            inline: 1,
            buttons: [{
                text: 'Close',
                onclick: 'close'
            }]
        }, {
            setContent: function(content) {
                e.execCommand('mceInsertContent', true, content);
            }
        })
    }
    e.addButton('filemanager', {
        icon: 'browse',
        tooltip: 'Insert file',
        onclick: openmanager,
        stateSelector: 'img:not([data-mce-object])'
    });
    e.addMenuItem('filemanager', {
        icon: 'browse',
        text: 'Insert file',
        onclick: openmanager,
        context: 'insert',
        prependToContext: true
    });
    return e.settings.file_browser_callback = openmanager, !1
});
